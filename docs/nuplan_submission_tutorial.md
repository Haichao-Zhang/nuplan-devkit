# nuPlan submissions

This tutorial will walk you through how to generate a valid submission, and send it to the evaluation server.

## Prerequisites

In this guide, it is assumed you followed the [`nuplan_framework` tutorial](./nuplan_framework.ipynb) and are familiar with the nuPlan environment.
It is suggested, but not required, to first go through this tutorial with the example Planner (`SimplePlanner`)
and then make the necessary modifications to use your custom planner.

Another requirement is to have a local Docker installation. You can follow the official documentation
[here](https://docs.docker.com/get-docker/).

## Submission infrastructure

To evaluate submitted planners, our team implemented a Docker-based framework.
Your submission will act as a server, run within a Docker container, providing the computation of trajectories as a
service, which will be called from the simulation run by us (the client).
A visualization of the architecture is available below.

![](./submission_architecture.svg)

### Protocol specifications

The client/server communication is made using [gRPC](https://grpc.io/), the configuration files and code related to
the communication can be found at [`~/nuplan_devkit/nuplan/submission`](../nuplan/submission).
In order for submissions to work as expected, the protocol files ([`protos/`](../nuplan/submission/protos)) and the autogenerated
([`challenge_pb2.py`](../nuplan/submission/challenge_pb2.py) and [`challenge_pb2_grpc.py`](../nuplan/submission/challenge_pb2_grpc.py)) files **MUST NOT** be modified, as we will use our version of them.

Similarly, you should not modify [`submission_container.py`](../nuplan/submission/submission_container.py) and only modify the specified section of
[`submission_planner.py`](/home/michael.noronha/nuDeep/nuplan_devkit/nuplan/submission/submission_planner.py), to avoid invalid submissions.

## Creating a valid submission <a name="creating_submission"></a>

To be able to run your planner, the basic requirement is that it needs to inherit from [AbstractPlanner](../nuplan/planning/simulation/planner/abstract_planner.py), and implement the relevant interfaces.

**Checkpoint** Run a simulation with your custom planner using the run_simulation script, as exemplified in the [tutorials](./).

Once you can run your planner, to be able to submit your planner for remote execution you will have to package it in a Docker container. Here are the steps:

1. [Dockerfile.submission](../Dockerfile.submission) is the starting point. You might not need to edit it directly, however, feel free to change it as you see fit.  If you need to edit the system dependencies you can do so by adding apt  targets as needed in Dockerfile.submission.
1. To add additional pip requirements you may need, please append them to [requirements_submission.txt](../requirements_submission.txt).
2. [submission_planner.py](../nuplan/submission/submission_planner.py) is where you have to instantiate your planner. In the current example, the SimplePlanner is instantiated with some values. Replace the SimplePlanner with your planner.

 At this point, you need to make sure that you can generate a valid Docker image from the Dockerfile you edited.

**Checkpoint** Create a Docker image using the edited Dockerfile.submission. If you are unfamiliar with Docker, the command below should be a good starting point (to be run within `nuplan_devkit/`):

```console
docker build --network host -f Dockerfile.submission . -t nuplan-evalservice-server:test.contestant
```

Once you created the docker image, you need to test its behavior in the sever-client architecture, to make sure everything works fine. To do so you can use docker-compose which should take care of everything for you.

[Optional] If you want to avoid downloading maps/datasets and want to see the results from the simulation, you should mount the relative volumes in the docker-compose file.

Checkpoint Run the simulation by running the command below:

```console
docker-compose up
```

## Submitting a solution <a name="submission"></a>

To submit through to EvalAI you will have to register on the EvalAI website. Then you will have to install the [CLI](https://cli.eval.ai/) and push your submission, with for example:

```console
evalai push your_name:submission_id --phase nuplan-test-1729
```

The results will be visible on the EvalAI leaderboard.

